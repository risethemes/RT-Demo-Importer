window.wp=window.wp||{};(function($){var demos,l10n;demos=wp.demos=wp.demos||{};demos.data=_demoImporterSettings;l10n=demos.data.l10n;demos.isNew=!!demos.data.settings.isNew;_.extend(demos,{model:{},view:{},routes:{},router:{},template:wp.template});demos.Model=Backbone.Model.extend({initialize:function(){var description;this.set({id:this.get('slug')||this.get('id')});if(this.has('sections')){description=this.get('sections').description;this.set({description:description})}}});demos.view.Appearance=wp.Backbone.View.extend({el:'#wpbody-content .wrap .theme-browser',window:$(window),page:0,initialize:function(options){_.bindAll(this,'scroller');this.SearchView=options.SearchView?options.SearchView:demos.view.Search;this.window.bind('scroll',_.throttle(this.scroller,300))},render:function(){this.view=new demos.view.Demos({collection:this.collection,parent:this});this.search();this.$el.removeClass('search-loading');this.view.render();this.$el.empty().append(this.view.el).addClass('rendered')},searchContainer:$('.search-form'),search:function(){var view,self=this;if(demos.data.demos.length===1){return}
view=new this.SearchView({collection:self.collection,parent:this});self.SearchView=view;view.render();this.searchContainer.append($.parseHTML('<label class="screen-reader-text" for="wp-filter-search-input">'+l10n.search+'</label>')).append(view.el).on('submit',function(event){event.preventDefault()})},scroller:function(){var self=this,bottom,threshold;bottom=this.window.scrollTop()+self.window.height();threshold=self.$el.offset().top+self.$el.outerHeight(!1)-self.window.height();threshold=Math.round(threshold*0.9);if(bottom>threshold){}}});demos.Collection=Backbone.Collection.extend({model:demos.Model,terms:'',doSearch:function(value){if(this.terms===value){return}
this.terms=value;if(this.terms.length>0){this.search(this.terms)}
if(this.terms===''){this.reset(demos.data.demos);$('body').removeClass('no-results')}
this.trigger('demos:update')},search:function(term){var match,results,haystack,name,description,author;this.reset(demos.data.demos,{silent:!0});term=term.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&');term=term.replace(/ /g,')(?=.*');match=new RegExp('^(?=.*'+term+').+','i');results=this.filter(function(data){name=data.get('name').replace(/(<([^>]+)>)/ig,'');description=data.get('description').replace(/(<([^>]+)>)/ig,'');author=data.get('author').replace(/(<([^>]+)>)/ig,'');haystack=_.union([name,data.get('id'),description,author,data.get('tags')]);if(match.test(data.get('author'))&&term.length>2){data.set('displayAuthor',!0)}
return match.test(haystack)});if(results.length===0){this.trigger('query:empty')}else{$('body').removeClass('no-results')}
this.reset(results)},paginate:function(instance){var collection=this;instance=instance||0;collection=_(collection.rest(20*instance));collection=_(collection.first(20));return collection},count:!1,query:function(request){var queries=this.queries,self=this,query,isPaginated,count;this.currentQuery.request=request;query=_.find(queries,function(query){return _.isEqual(query.request,request)});isPaginated=_.has(request,'page');if(!isPaginated){this.currentQuery.page=1}
if(!query&&!isPaginated){query=this.apiCall(request).done(function(data){if(data.demos){self.reset(data.demos);count=data.info.results;queries.push({demos:data.demos,request:request,total:count})}
self.trigger('demos:update');self.trigger('query:success',count);if(data.demos&&data.demos.length===0){self.trigger('query:empty')}}).fail(function(){self.trigger('query:fail')})}else{if(isPaginated){return this.apiCall(request,isPaginated).done(function(data){self.add(data.demos);self.trigger('query:success');self.loadingDemos=!1}).fail(function(){self.trigger('query:fail')})}
if(query.demos.length===0){self.trigger('query:empty')}else{$('body').removeClass('no-results')}
if(_.isNumber(query.total)){this.count=query.total}
this.reset(query.demos);if(!query.total){this.count=this.length}
this.trigger('demos:update');this.trigger('query:success',this.count)}},queries:[],currentQuery:{page:1,request:{}},apiCall:function(request,paginated){return wp.ajax.send('query-demos',{data:{request:_.extend({per_page:100},request)},beforeSend:function(){if(!paginated){$('body').addClass('loading-content').removeClass('no-results')}}})},loadingDemos:!1});demos.view.Demo=wp.Backbone.View.extend({className:'theme',state:'grid',html:demos.template('demo'),events:{'click':'preview','keydown':'preview','touchend':'preview','keyup':'addFocus','touchmove':'preventExpand','click .demo-import':'importDemo'},touchDrag:!1,initialize:function(){this.model.on('change',this.render,this)},render:function(){var data=this.model.toJSON();this.$el.html(this.html(data)).attr({tabindex:0,'aria-describedby':data.id+'-action '+data.id+'-name','data-slug':data.id});this.activeDemo();if(this.model.get('displayAuthor')){this.$el.addClass('display-author')}},activeDemo:function(){if(this.model.get('active')){this.$el.addClass('active')}},addFocus:function(){var $demoToFocus=($(':focus').hasClass('theme'))?$(':focus'):$(':focus').parents('.theme');$('.theme.focus').removeClass('focus');$demoToFocus.addClass('focus')},preventExpand:function(){this.touchDrag=!0},preview:function(event){var self=this,current,preview;event=event||window.event;if(this.touchDrag===!0){return this.touchDrag=!1}
if($(event.target).not('.install-demo-preview').parents('.theme-actions').length){return}
if(event.type==='keydown'&&(event.which!==13&&event.which!==32)){return}
if(event.type==='keydown'&&event.which!==13&&$(':focus').hasClass('button')){return}
event.preventDefault();event=event||window.event;demos.focusedDemo=this.$el;demos.preview=preview=new demos.view.Preview({model:this.model});preview.render();this.setNavButtonsState();if(this.model.collection.length===1){preview.$el.addClass('no-navigation')}else{preview.$el.removeClass('no-navigation')}
$('div.wrap').append(preview.el);this.listenTo(preview,'demo:next',function(){current=self.model;if(!_.isUndefined(self.current)){current=self.current}
self.current=self.model.collection.at(self.model.collection.indexOf(current)+1);if(_.isUndefined(self.current)){self.options.parent.parent.trigger('demo:end');return self.current=current}
preview.model=self.current;preview.render();this.setNavButtonsState();$('.next-theme').focus()}).listenTo(preview,'demo:previous',function(){current=self.model;if(self.model.collection.indexOf(self.current)===0){return}
if(!_.isUndefined(self.current)){current=self.current}
self.current=self.model.collection.at(self.model.collection.indexOf(current)-1);if(_.isUndefined(self.current)){return}
preview.model=self.current;preview.render();this.setNavButtonsState();$('.previous-theme').focus()});this.listenTo(preview,'preview:close',function(){self.current=self.model})},setNavButtonsState:function(){var $demoInstaller=$('.theme-install-overlay'),current=_.isUndefined(this.current)?this.model:this.current,previousDemoButton=$demoInstaller.find('.previous-theme'),nextDemoButton=$demoInstaller.find('.next-theme');if(0===this.model.collection.indexOf(current)){previousDemoButton.addClass('disabled').prop('disabled',!0);nextDemoButton.focus()}
if(_.isUndefined(this.model.collection.at(this.model.collection.indexOf(current)+1))){nextDemoButton.addClass('disabled').prop('disabled',!0);previousDemoButton.focus()}},importDemo:function(event){var _this=this,$target=$(event.target);event.preventDefault();if($target.hasClass('disabled')){return}
if(!window.confirm(wp.demos.data.settings.confirmImport)){return}
wp.updates.maybeRequestFilesystemCredentials(event);$(document).on('wp-demo-import-success',function(event,response){if(_this.model.get('id')===response.slug){_this.model.set({'imported':!0})}});wp.updates.importDemo({slug:$target.data('slug')})}});demos.view.Preview=wp.Backbone.View.extend({className:'wp-full-overlay expanded',el:'.theme-install-overlay',events:{'click .close-full-overlay':'close','click .collapse-sidebar':'collapse','click .devices button':'previewDevice','click .previous-theme':'previousDemo','click .next-theme':'nextDemo','keyup':'keyEvent','click .demo-import':'importDemo','click .plugins-install':'installPlugins'},html:demos.template('demo-preview'),render:function(){var self=this,currentPreviewDevice,data=this.model.toJSON(),$body=$(document.body);$body.attr('aria-busy','true');this.$el.removeClass('iframe-ready').html(this.html(data));currentPreviewDevice=this.$el.data('current-preview-device');if(currentPreviewDevice){self.tooglePreviewDeviceButtons(currentPreviewDevice)}
demos.router.navigate(demos.router.baseUrl(demos.router.demoPath+this.model.get('id')),{replace:!1});this.$el.fadeIn(200,function(){$body.addClass('demo-importer-active full-overlay-active')});this.$el.find('iframe').one('load',function(){self.iframeLoaded()})},iframeLoaded:function(){this.$el.addClass('iframe-ready');$(document.body).attr('aria-busy','false')},close:function(){this.$el.fadeOut(200,function(){$('body').removeClass('demo-importer-active full-overlay-active');if(demos.focusedDemo){demos.focusedDemo.focus()}}).removeClass('iframe-ready');if(demos.router.selectedTab){demos.router.navigate(demos.router.baseUrl('&browse='+demos.router.selectedTab))}else{demos.router.navigate(demos.router.baseUrl(''))}
this.trigger('preview:close');this.undelegateEvents();this.unbind();return!1},collapse:function(event){var $button=$(event.currentTarget);if('true'===$button.attr('aria-expanded')){$button.attr({'aria-expanded':'false','aria-label':l10n.expandSidebar})}else{$button.attr({'aria-expanded':'true','aria-label':l10n.collapseSidebar})}
this.$el.toggleClass('collapsed').toggleClass('expanded');return!1},previewDevice:function(event){var device=$(event.currentTarget).data('device');this.$el.removeClass('preview-desktop preview-tablet preview-mobile').addClass('preview-'+device).data('current-preview-device',device);this.tooglePreviewDeviceButtons(device)},tooglePreviewDeviceButtons:function(newDevice){var $devices=$('.wp-full-overlay-footer .devices');$devices.find('button').removeClass('active').attr('aria-pressed',!1);$devices.find('button.preview-'+newDevice).addClass('active').attr('aria-pressed',!0)},keyEvent:function(event){if(event.keyCode===27){this.undelegateEvents();this.close()}
if(event.keyCode===39){_.once(this.nextDemo())}
if(event.keyCode===37){this.previousDemo()}},nextDemo:function(){var self=this;self.trigger('demo:next',self.model.cid);return!1},previousDemo:function(){var self=this;self.trigger('demo:previous',self.model.cid);return!1},importDemo:function(event){var _this=this,$target=$(event.target);event.preventDefault();if($target.hasClass('disabled')||$target.hasClass('updating-message')){return}
if(!window.confirm(wp.demos.data.settings.confirmImport)){return}
wp.updates.maybeRequestFilesystemCredentials(event);$('.theme-install-overlay').find('.next-theme, .previous-theme').addClass('disabled');$(document).on('wp-demo-import-success',function(event,response){if(_this.model.get('id')===response.slug){_this.model.set({'imported':!0})}});wp.updates.importDemo({slug:$target.data('slug')})},installPlugins:function(event){var _this=this,pluginsList=$('.plugins-list-table').find('#the-list tr'),$target=$('.plugins-install'),success=0,error=0,errorMessages=[];event.preventDefault();if($target.hasClass('disabled')||$target.hasClass('updating-message')){return}
if(pluginsList.length){$('.wp-full-overlay-sidebar-content').animate({scrollTop:$(document).height()});if($target.html()!==wp.updates.l10n.installing){$target.data('originaltext',$target.html())}
$target.addClass('updating-message').text(wp.updates.l10n.installing);wp.a11y.speak(wp.updates.l10n.installingMsg,'polite');$('.theme-install-overlay').find('.next-theme, .previous-theme').addClass('disabled')}
wp.updates.maybeRequestFilesystemCredentials(event);$(document).trigger('wp-plugin-bulk-install',pluginsList);pluginsList.each(function(index,element){var $itemRow=$(element);if(!$itemRow.hasClass('inactive')||$itemRow.find('notice-error').length){return}
wp.updates.queue.push({action:'install-plugin',data:{plugin:$itemRow.data('plugin'),slug:$itemRow.data('slug')}})});$(document).on('wp-plugin-bulk-install-success wp-plugin-bulk-install-error',function(event,response){var $itemRow=$('[data-slug="'+response.slug+'"]'),$bulkActionNotice,itemName;if('wp-'+response.install+'-bulk-install-success'===event.type){success++}else{itemName=response.pluginName?response.pluginName:$itemRow.find('.plugin-name').text();error++;errorMessages.push(itemName+': '+response.errorMessage)}
wp.updates.adminNotice=wp.template('wp-bulk-installs-admin-notice');$('.plugins-details .bulk-action-notice').remove();$('.plugins-details .plugins-info').after(wp.updates.adminNotice({id:'bulk-action-notice',className:'bulk-action-notice notice-alt',successes:success,errors:error,errorMessages:errorMessages,type:response.install}));$bulkActionNotice=$('#bulk-action-notice').on('click','button',function(){$(this).toggleClass('bulk-action-errors-collapsed').attr('aria-expanded',!$(this).hasClass('bulk-action-errors-collapsed'));$bulkActionNotice.find('.bulk-action-errors').toggleClass('hidden')});if(!wp.updates.queue.length){if(error>0){$target.removeClass('updating-message').text($target.data('originaltext'))}else{_this.model.set({requiredPlugins:!1});_this.render();$('.theme-install-overlay').find('.next-theme, .previous-theme').addClass('disabled')}}});$(document).on('wp-updates-notice-added',function(){wp.updates.adminNotice=wp.template('wp-updates-admin-notice')});wp.updates.queueChecker()}});demos.view.Demos=wp.Backbone.View.extend({className:'themes wp-clearfix',$overlay:$('div.theme-overlay'),index:0,count:$('.wrap .demo-count'),liveDemoCount:0,initialize:function(options){var self=this;this.parent=options.parent;this.setView('grid');self.importedDemo();this.listenTo(self.collection,'demos:update',function(){self.parent.page=0;self.importedDemo();self.render(this)});this.listenTo(self.collection,'query:success',function(count){if(_.isNumber(count)){self.count.text(count);self.announceSearchResults(count)}else{self.count.text(self.collection.length);self.announceSearchResults(self.collection.length)}});this.listenTo(self.collection,'query:empty',function(){$('body').addClass('no-results')});this.listenTo(this.parent,'demo:scroll',function(){self.renderDemos(self.parent.page)})},render:function(){this.$el.empty();if(this.options.collection.size()>0){this.renderDemos(this.parent.page)}
this.liveDemoCount=this.collection.count?this.collection.count:this.collection.length;this.count.text(this.liveDemoCount)},renderDemos:function(page){var self=this;self.instance=self.collection.paginate(page);if(self.instance.size()===0){this.parent.trigger('demo:end');return}
if(demos.isNew&&page>=1){$('.add-new-theme').remove()}
self.instance.each(function(demo){self.demo=new demos.view.Demo({model:demo,parent:self});self.demo.render();self.$el.append(self.demo.el)});if(demos.isNew&&demos.data.settings.suggestURI){this.$el.append('<div class="theme add-new-theme"><a href="'+demos.data.settings.suggestURI+'" target="blank"><div class="theme-screenshot"><span></span></div><h2 class="theme-name">'+l10n.suggestNew+'</h2></a></div>')}
this.parent.page++},importedDemo:function(){var self=this,current;current=self.collection.findWhere({active:!0});if(current){self.collection.remove(current);self.collection.add(current,{at:0})}},setView:function(view){return view},announceSearchResults:function(count){if(0===count){wp.a11y.speak(l10n.noDemosFound)}else{wp.a11y.speak(l10n.demosFound.replace('%d',count))}}});demos.view.Search=wp.Backbone.View.extend({tagName:'input',className:'wp-filter-search',id:'wp-filter-search-input',searching:!1,attributes:{placeholder:l10n.searchPlaceholder,type:'search','aria-describedby':'live-search-desc'},events:{'input':'search','keyup':'search','blur':'pushState'},initialize:function(options){this.parent=options.parent;this.listenTo(this.parent,'demo:close',function(){this.searching=!1})},search:function(event){if(event.type==='keyup'&&event.which===27){event.target.value=''}
this.doSearch(event)},doSearch:function(event){var options={};this.collection.doSearch(event.target.value.replace(/\+/g,' '));if(this.searching&&event.which!==13){options.replace=!0}else{this.searching=!0}
if(event.target.value){demos.router.navigate(demos.router.baseUrl(demos.router.searchPath+event.target.value),options)}else{demos.router.navigate(demos.router.baseUrl(''))}},pushState:function(event){var url=demos.router.baseUrl('');if(event.target.value){url=demos.router.baseUrl(demos.router.searchPath+encodeURIComponent(event.target.value))}
this.searching=!1;demos.router.navigate(url)}});function navigateRouter(url,state){var router=this;if(Backbone.history._hasPushState){Backbone.Router.prototype.navigate.call(router,url,state)}}
demos.Router=Backbone.Router.extend({routes:{'themes.php?page=rt-demo-importer&demo=:slug':'preview','themes.php?page=rt-demo-importer&browse=:sort':'sort','themes.php?page=rt-demo-importer&search=:query':'search','themes.php?page=rt-demo-importer':'sort'},baseUrl:function(url){return'themes.php?page=rt-demo-importer'+url},demoPath:'&demo=',browsePath:'&browse=',searchPath:'&search=',search:function(query){$('.wp-filter-search').val(query.replace(/\+/g,' '))},navigate:navigateRouter});demos.view.InstallerSearch=demos.view.Search.extend({events:{'input':'search','keyup':'search'},terms:'',search:function(event){if(event.type==='keyup'&&(event.which===9||event.which===16)){return}
this.collection=this.options.parent.view.collection;if(event.type==='keyup'&&event.which===27){event.target.value=''}
this.doSearch(event.target.value)},doSearch:function(value){var request={};if(this.terms===value){return}
this.terms=value;request.search=value;$('.filter-links li > a.current').removeClass('current').removeAttr('aria-current');this.collection.doSearch(value.replace(/\+/g,' '));demos.router.navigate(demos.router.baseUrl(demos.router.searchPath+encodeURIComponent(value)),{replace:!0})}});demos.view.Installer=demos.view.Appearance.extend({el:'#wpbody-content .wrap',events:{'click .filter-links li > a':'onSort'},render:function(){var self=this;this.search();this.collection=new demos.Collection();this.listenTo(this,'demo:end',function(){if(self.collection.loadingDemos){return}
self.collection.loadingDemos=!0;self.collection.currentQuery.page++;_.extend(self.collection.currentQuery.request,{page:self.collection.currentQuery.page});self.collection.query(self.collection.currentQuery.request)});this.listenTo(this.collection,'query:success',function(){$('body').removeClass('loading-content');$('.theme-browser').find('div.error').remove()});this.listenTo(this.collection,'query:fail',function(){$('body').removeClass('loading-content');$('.theme-browser').find('div.error').remove();$('.theme-browser').find('div.themes').before('<div class="error"><p>'+l10n.error+'</p><p><button class="button try-again">'+l10n.tryAgain+'</button></p></div>');$('.theme-browser .error .try-again').on('click',function(e){e.preventDefault();$('input.wp-filter-search').trigger('input')})});if(this.view){this.view.remove()}
this.view=new demos.view.Demos({collection:this.collection,parent:this});this.page=0;this.$el.find('.themes').remove();this.view.render();this.$el.find('.theme-browser').append(this.view.el).addClass('rendered')},browse:function(section,builder){this.collection.query({browse:section,builder:builder})},onSort:function(event){var $el=$(event.target),sort=$el.data('sort'),type=$el.data('type');event.preventDefault();sort=sort?sort:demos.router.selectedTab;type=type?type:demos.router.selectedType;if($el.hasClass(this.activeClass)){return}
this.sort(sort,type);demos.router.navigate(demos.router.baseUrl(demos.router.browsePath+sort))},sort:function(sort,type){this.clearSearch();demos.router.selectedTab=sort;demos.router.selectedType=type;$('.filter-links li > a').removeClass(this.activeClass).removeAttr('aria-current');$('[data-sort="'+sort+'"]').addClass(this.activeClass).attr('aria-current','page');$('[data-type="'+type+'"]').addClass(this.activeClass).attr('aria-current','page');this.browse(sort,type)},activeClass:'current',clearSearch:function(){$('#wp-filter-search-input').val('')}});demos.RunInstaller={init:function(){this.view=new demos.view.Installer({section:'all',SearchView:demos.view.InstallerSearch});this.render();this.view.SearchView.doSearch=_.debounce(this.view.SearchView.doSearch,500)},render:function(){this.view.render();this.routes();if(Backbone.History.started){Backbone.history.stop()}
Backbone.history.start({root:demos.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var self=this,request={};demos.router=new demos.Router();demos.router.on('route:preview',function(slug){if(demos.preview){demos.preview.undelegateEvents();demos.preview.unbind()}
if(self.view.view.demo&&self.view.view.demo.preview){self.view.view.demo.model=self.view.collection.findWhere({'slug':slug});self.view.view.demo.preview()}else{request.demo=slug;self.view.collection.query(request);self.view.collection.trigger('update');self.view.collection.once('query:success',function(){$('div[data-slug="'+slug+'"]').trigger('click')})}});demos.router.on('route:sort',function(sort){var type=demos.router.selectedType?demos.router.selectedType:$('.filter-links.pagebuilders li').first().find('a').data('type');if(!sort||!$('[data-sort="'+sort+'"]').length){sort='all';demos.router.navigate(demos.router.baseUrl('&browse=all'),{replace:!0})}
self.view.sort(sort,type);if(demos.preview){demos.preview.close()}});demos.router.on('route:search',function(){$('.wp-filter-search').focus().trigger('keyup')});this.extraRoutes()},extraRoutes:function(){return!1}};$(document).ready(function(){demos.RunInstaller.init();$(document.body).on('init_tooltips',function(){$('#tiptip_holder').removeAttr('style');$('#tiptip_arrow').removeAttr('style');$('.tips').tipTip({'attribute':'data-tip','defaultPosition':'top','fadeIn':50,'fadeOut':50,'delay':50})}).trigger('init_tooltips');$('.rt-reset-wordpress').on('click',function(){return window.confirm(_demoImporterSettings.settings.confirmReset)});$('.rt-demo-importer-rating-link').on('click',function(){var $this_el=$(this);$.post(demos.data.settings.ajaxUrl,{action:'footer-text-rated'});$this_el.parent().text($this_el.data('rated'))})})})(jQuery)